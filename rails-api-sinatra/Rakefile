# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.

require_relative "config/application"

Rails.application.load_tasks

namespace :sinatra do
  task :migrate, [:version] do |t, args|
    require "sequel"
    require_relative "lib/sinatra/db"
    Sequel.extension :migration
    version = args[:version].to_i if args[:version]
    Sequel::Migrator.run(DB, "lib/sinatra/migrations", target: version)
  end

  task :create_movies do
    require "csv"
    require_relative "lib/sinatra/server"
    csv = CSV.read("#{__dir__}/lib/sinatra/movies.csv", headers: true,  encoding: "ISO-8859-1")
    movies = csv.map do |line|
      {
        rank: line["Rank"],
        title: line["Title"],
        description: line["Description"],
        runtime: line["Runtime"],
        genre: line["Genre"],
        rating: line["Rating"],
        metascore: use_if_integer(line["Metascore"]),
        votes: use_if_integer(line["Votes"]),
        gross_earning_on_million: use_if_float(line["Gross_Earning_in_Mil"]),
        director: line["Director"],
        actor: line["Actor"],
        year: line["Year"],
        updated_at: Time.now,
        created_at: Time.now
      }
    end

    DB[:movies].multi_insert(movies)
  end

  def use_if_integer(value)
    value.to_i.to_s == value ? value : nil
  end

  def use_if_float(value)
    value.to_f.to_s == value ? value : nil
  end
end
